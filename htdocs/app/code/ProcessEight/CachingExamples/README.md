# Process Eight CachingExamples

## Purpose

Miscellaneous research relating to caching in Magento 2.

## Research

### Demonstrate the ability to manage the cache

#### Describe cache types and the tools used to manage caches

There are thirteen cache types, defined in seven `etc/cache.xml` files.

@todo Can cache.xml be defined in different areas (frontend, adminhtml, webapi_rest, etc)? 
I don't think so. Certainly there are no examples of that in the core codebase.

@todo What invalidates each of these caches? (Hint: Look through tests and see it there are any which test cache invalidation)
To invalidate cache type(s), inject the `\Magento\Framework\App\Cache\TypeListInterface` and invoke the `\Magento\Framework\App\Cache\TypeListInterface::invalidate` method. This method accepts either a string or array of cache type codes.

##### Cache types

###### Configuration (`config`)

Purpose: Caches configuration stored in XML files (where the parent node is `<config>`) and in the `core_config_data` table of the database.

Defined in: `htdocs/vendor/magento/module-store/etc/cache.xml`

Invalidated by the following actions/processes: 
* Editing any XML file with a parent node of `<config>` 
* Updating the config in the admin (See: `\Magento\Framework\App\Config\Value::afterSave`)
* Whenever Currency Symbols are updated (See: `\Magento\CurrencySymbol\Model\System\Currencysymbol::clearCache`)

@todo Does directly editing the `core_config_data` table invalidate the cache?

###### Layout (`layout`)

Purpose: Caches Layout XML directives defined in Layout XML files and UI Component XML. 
* @todo Are Layout XML directives defined in 'Layout Updates' sections of the admin cached?
* @todo Is the cache invalidated by editing PHTML template files?

Defined in: `htdocs/vendor/magento/module-store/etc/cache.xml`

Invalidated by the following actions/processes:
* Whenever Currency Symbols are updated (See: `\Magento\CurrencySymbol\Model\System\Currencysymbol::clearCache`)

###### Blocks HTML Output (`block_html`)

Purpose: Caches the HTML output of the block rendering process (e.g. The _toHtml() method of each block).

Defined in: `htdocs/vendor/magento/module-store/etc/cache.xml` 

Invalidated by the following actions/processes: 
* Whenever RSS is enabled/disabled in the admin (See: `\Magento\Rss\Model\System\Config\Backend\Links::afterSave`)
* When swatches are updated (See: `\Magento\Swatches\Plugin\Catalog\CacheInvalidate::afterSave`)
* When the URL Rewrite Suffix is changed (See: `\Magento\Catalog\Model\System\Config\Backend\Catalog\Url\Rewrite\Suffix`)
* Whenever Currency Symbols are updated (See: `\Magento\CurrencySymbol\Model\System\Currencysymbol::clearCache`)

###### Collections Data (`collections`)

Purpose: Caches the result of loading collections.

Defined in: `htdocs/vendor/magento/module-store/etc/cache.xml`

Invalidated by the following actions/processes:
* When swatches are updated (See: `\Magento\Swatches\Plugin\Catalog\CacheInvalidate::afterSave`)
* When the URL Rewrite Suffix is changed (See: `\Magento\Catalog\Model\System\Config\Backend\Catalog\Url\Rewrite\Suffix`)

###### Reflections Data (`reflection`)

Purpose: Reflection data generated by reflecting the API interface classes (those located in the `Api` folder of each module).

Defined in: `htdocs/vendor/magento/module-store/etc/cache.xml`

Invalidated by the following actions/processes: @todo

###### Database DDL Operations (`db_ddl`)

Purpose: Caches results of DDL operations, e.g. Describing database tables or indexes.

Defined in: `htdocs/vendor/magento/module-store/etc/cache.xml`

Invalidated by the following actions/processes: 
* Executing any DDL operation via the methods in the `\Magento\Framework\DB\Adapter\AdapterInterface` class, e.g. Operations which result in `CREATE`, `RENAME`, `ALTER`, `DROP` statements.

###### EAV Types and Attributes (`eav`)

Purpose: Caches data relating to EAV entities, attributes, attribute codes and attribute sets.

Defined in: `htdocs/vendor/magento/module-eav/etc/cache.xml` 

Invalidated by the following actions/processes: @todo

###### Customer Notification (`customer_notification`)

Purpose: Not entirely sure. Seems to cache a flag upon saving the Customer/Customer Address entity (See `\Magento\Customer\Model\ResourceModel\Customer::_afterSave`), which is then retrieved in a plugin which regenerates the Customer's session (See: `\Magento\Customer\Model\Plugin\CustomerNotification::beforeDispatch`).

Defined in: `htdocs/vendor/magento/module-customer/etc/cache.xml`

Invalidated by the following actions/processes: @todo

###### Integrations Configuration (`config_integration`)

Purpose: 

Defined in: `htdocs/vendor/magento/module-integration/etc/cache.xml`

Invalidated by the following actions/processes: @todo

###### Integrations API Configuration (`config_integration_api`)

Purpose: 

Defined in: `htdocs/vendor/magento/module-integration/etc/cache.xml`

Invalidated by the following actions/processes: @todo

###### Page Cache (`full_page`)

Purpose: Caches the results of rendering entire pages, not just individual blocks.

Defined in: `htdocs/vendor/magento/module-page-cache/etc/cache.xml`

Invalidated by the following actions/processes: 
* After saving an attribute (See: `\Magento\Catalog\Plugin\Model\ResourceModel\Attribute\Save::afterSave`)
* After a full re-index of `catalog_category_product` has been executed (See: `\Magento\Catalog\Plugin\Model\Indexer\Category\Product\Execute::afterExecute`)
* Whenever Tier Prices are modified (See: `\Magento\Catalog\Model\Product\Price\TierPriceStorage::invalidateFullPageCache`)
* Whenever the following events are dispatched (they all call the same Observer: `\Magento\PageCache\Observer\InvalidateCache`):
    * `clean_media_cache_after`
    * `clean_catalog_images_cache_after`
    * `assign_theme_to_stores_after`
    * `controller_action_postdispatch_adminhtml_system_currency_saveRates`
    * `controller_action_postdispatch_adminhtml_system_config_save`
    * `controller_action_postdispatch_adminhtml_system_currencysymbol_save`
* Whenever Currency Symbols are updated (See: `\Magento\CurrencySymbol\Model\System\Currencysymbol::clearCache`)
* Whenever a theme is saved or deleted (See: `\Magento\Theme\Model\Design\Backend\Theme::invalidateCache`)

###### Translations (`translate`)

Purpose: Caches translations read from translation files. (@todo Verify that this caches translations added in the admin/through other methods (if there are other methods) as well)

Defined in: `htdocs/vendor/magento/module-translation/etc/cache.xml`

Invalidated by the following actions/processes: 
* Whenever a Translation is saved (See: `\Magento\Config\Model\Config\Backend\Translate::afterSave`)

###### Web Services Configuration (`config_webservice`)

Purpose: REST and SOAP API web service configurations, as defined in the `etc/webapi.xml` file of each module. Also includes generated WSDL files for modules which define SOAP services.

Defined in: `htdocs/vendor/magento/module-webapi/etc/cache.xml`

Invalidated by the following actions/processes: 
* Editing `etc/webapi.xml` files.
* If the `webapi/webapisecurity/allow_insecure` config path is updated (See `\Magento\WebapiSecurity\Model\Plugin\CacheInvalidator`).

##### Tools used to manage caches

###### The `bin/magento` cache commands

What do they do?

What is the difference between `cache:clean` and `cache:flush`?

How do they manage/handle cleaning caches stored in alternative (non-file based) storage (e.g. Redis)?

Are there any other core tools used to manage/manipulate the cache?
